---
created: 2025-11-28
updated: 2025-11-28
version: 0.2.0
status: draft
parent: '[[spec]]'
---

# Rackarr v0.2.0 — Multi-View & Polish

**Parent Spec:** [[spec|v0.1 Base Specification]]

This document extends the base specification with v0.2-specific features and amendments.

---

## 1. Version Overview

### 1.1 Goals

- Add rear rack view capability
- Improve canvas usability with fit-all zoom
- Enable rack duplication for faster layout building
- Enhance device library management
- UI polish and refinements

### 1.2 Breaking Changes

None. v0.2 layouts are backward-compatible with v0.1.

---

## 2. Spec Amendments

These changes **modify** the base v0.1 specification.

### 2.1 Toolbar Contents (Amends Section 3.2)

Replace the toolbar specification with:

| Button/Control                   | Action                            |
| -------------------------------- | --------------------------------- |
| **Device Library** (icon + text) | Toggles Device Library drawer     |
| **New Rack**                     | Opens new rack form               |
| **Save**                         | Download layout as YAML           |
| **Load**                         | Upload YAML layout file           |
| **Export**                       | Opens export dialog               |
| **Delete**                       | Deletes selected item             |
| **Zoom +/-**                     | Zoom controls                     |
| **Fit All**                      | Zoom to fit all racks in viewport |
| **Dark/Light toggle**            | Switch theme                      |
| **Help**                         | Opens Help/About panel            |

**Changes from v0.1:**

- "App logo + Rackarr" now functions as Device Library toggle (not branding link)
- Removed separate "Device Palette" button (replaced by Device Library button)
- Added "Fit All" zoom button
- Renamed "Device Palette" to "Device Library" throughout

### 2.2 Device Library Toggle Button (New Section 3.2.1)

The leftmost toolbar element combines branding with functionality:

**Visual Composition:**

- Rackarr icon (SVG, height slightly taller than text baseline — approximately 20px when text is 14px)
- "Device Library" text label
- Gap: 8px between icon and text

**Interaction States:**

| State                    | Visual Treatment                                                           |
| ------------------------ | -------------------------------------------------------------------------- |
| **Default**              | Standard toolbar button appearance                                         |
| **Hover**                | `var(--colour-surface-hover)` background                                   |
| **Active (drawer open)** | `var(--colour-selection)` background at 20% opacity, text colour unchanged |
| **Focus**                | Standard focus ring (`2px solid var(--colour-selection)`)                  |

**CSS Implementation:**

```css
.device-library-toggle {
	display: flex;
	align-items: center;
	gap: 8px;
	padding: 8px 12px;
	border-radius: 4px;
	background: transparent;
	transition: background-color var(--transition-fast);
}

.device-library-toggle:hover {
	background: var(--colour-surface-hover);
}

.device-library-toggle[aria-expanded='true'] {
	background: color-mix(in srgb, var(--colour-selection) 20%, transparent);
}

.device-library-toggle .icon {
	height: 20px;
	width: auto;
}
```

**Accessibility:**

- `aria-expanded="true|false"` reflects drawer state
- `aria-controls="device-library-drawer"`
- Keyboard: `D` key toggles (unchanged from v0.1)

### 2.3 Device Library Drawer (Amends Section 6.4)

**Changes from v0.1:**

- Rename from "Device Palette" to "Device Library"
- Remove close button (X) from drawer header
- Closing method: Click toggle button again, press `Escape`, or press `D`

### 2.4 Help/About Panel (Amends Section 15.3)

**Remove from Help/About contents:**

- Forgejo repository link (internal infrastructure, not public)

**Keep:**

- App name and version
- Brief description
- Keyboard shortcuts reference
- GitHub repository link (mirror, now primary public link)
- License (MIT)
- Credits/attribution

### 2.5 Rack Title Position (Amends Section 5.3)

**Change:** Rack title displays **above** the rack, not below.

**Canvas rendering:**

```
        Rack Name
    ┌──────────────┐
    │ [42] ▢▢▢     │
    │ [41] ▢▢▢     │
    │  ...         │
    │ [1]  ▢▢▢     │
    └──────────────┘
```

**Export rendering:** Same — title above rack in all export formats.

**Implementation:**

- Title positioned with `text-anchor: middle` centered on rack width
- Vertical position: `RACK_PADDING - 8px` (8px above rack top)
- Font: Same as current (system-ui, 14px, semibold)

### 2.6 Device Icon Vertical Alignment (Amends Section 6.4)

**Issue:** Category icons in device boxes appear bottom-biased.

**Fix:** Vertically centre icons within device rectangle.

**CSS Implementation:**

```css
.device-content {
	display: flex;
	align-items: center;
	justify-content: flex-start;
	height: 100%;
}
```

For SVG rendering in exports:

```javascript
// Icon vertical position — centre of device
const iconY = deviceY + deviceHeight / 2;
// Use dominant-baseline="middle" for SVG text/icons
```

---

## 3. New Features

### 3.1 Rear Rack View

#### 3.1.1 Data Model Extension

Add to `Rack` interface:

```typescript
interface Rack {
	// ... existing properties
	view: 'front' | 'rear'; // New: which side is displayed
}
```

Add to `PlacedDevice` interface:

```typescript
interface PlacedDevice {
	// ... existing properties
	face: 'front' | 'rear' | 'both'; // New: which face(s) device occupies
}
```

**Default values:**

- `Rack.view`: `'front'`
- `PlacedDevice.face`: `'front'`

#### 3.1.2 View Toggle

**Location:** Rack header area (above rack title)

**Visual:** Segmented control: `[Front | Rear]`

**Behaviour:**

- Clicking "Rear" shows devices with `face: 'rear'` or `face: 'both'`
- Clicking "Front" shows devices with `face: 'front'` or `face: 'both'`
- U numbers remain in same positions (not mirrored)
- View state is per-rack (each rack can show different view)

#### 3.1.3 Device Face Assignment

**Edit Panel Addition:**
When device selected, show "Mounted Face" property:

- Radio buttons: Front / Rear / Both (full-depth)
- Default: Front

**Visual Indication:**

- Front-only devices: Normal appearance
- Rear-only devices: Normal appearance (only visible in rear view)
- Full-depth devices: Subtle indicator (↔ symbol or depth icon)

#### 3.1.4 Export Behaviour

**Single export:** Exports currently visible view per rack.

**Future consideration (not v0.2):** Option to export both views side-by-side.

### 3.2 Fit All Zoom

#### 3.2.1 Behaviour

Calculate zoom level and pan position to fit all racks within the visible canvas area with padding.

**Algorithm:**

```javascript
function fitAll(racks, viewportWidth, viewportHeight) {
	if (racks.length === 0) return { zoom: 1, panX: 0, panY: 0 };

	const bounds = calculateRacksBoundingBox(racks);
	const padding = 48;
	const contentWidth = bounds.width + padding * 2;
	const contentHeight = bounds.height + padding * 2;

	const zoomX = viewportWidth / contentWidth;
	const zoomY = viewportHeight / contentHeight;
	const zoom = Math.min(zoomX, zoomY, 2); // Cap at 200%

	const panX = (viewportWidth - bounds.width * zoom) / 2 - bounds.x * zoom;
	const panY = (viewportHeight - bounds.height * zoom) / 2 - bounds.y * zoom;

	return { zoom, panX, panY };
}
```

#### 3.2.2 Toolbar Button

**Icon:** Expand/fit icon (four arrows pointing outward)
**Tooltip:** "Fit All (F)"
**Keyboard shortcut:** `F`

#### 3.2.3 Animation

Animate zoom/pan transition over 200ms with `ease-out` easing.
Respect `prefers-reduced-motion` — instant transition if reduced motion preferred.

### 3.3 Rack Duplication

#### 3.3.1 Trigger

**Context menu:** Right-click rack → "Duplicate Rack"
**Keyboard:** Select rack → `Ctrl/Cmd + D`

#### 3.3.2 Behaviour

1. Create deep copy of rack (new UUID)
2. Copy all placed devices (new UUIDs, same positions and faces)
3. Append " (Copy)" to rack name
4. Position new rack to the right of original
5. If 6 racks already exist, show error toast

#### 3.3.3 Device Library Handling

Duplicated devices reference the same library entries (no duplication of library items).

### 3.4 Device Library Import

#### 3.4.1 Import Format

Accept JSON file with array of devices:

```json
{
	"name": "My Device Library",
	"devices": [
		{
			"name": "Custom Server",
			"height": 2,
			"category": "server",
			"colour": "#4A90D9",
			"notes": "Optional notes"
		}
	]
}
```

#### 3.4.2 Import Behaviour

**Merge strategy:** Add imported devices to existing library (no replacement).

**Duplicate handling:** If device with same name exists, append "(imported)" to new device name.

**Validation:**

- Reject invalid categories
- Reject invalid heights (< 0.5 or > 100)
- Skip invalid entries, import valid ones
- Show summary toast: "Imported X devices (Y skipped)"

#### 3.4.3 UI Location

**Device Library drawer:** "Import" button near "Add Device" button.

---

## 4. Technical Implementation

### 4.1 Zoom/Pan Library: panzoom

**Decision:** Adopt [panzoom](https://github.com/anvaka/panzoom) (~3KB) for canvas zoom and pan.

**Rationale:**

- Provides smooth momentum-based animations
- Handles bounds constraints
- Framework-agnostic, works with SVG
- Eliminates need for custom zoom/pan code
- Enables future continuous scroll-wheel zoom

**Integration:**

```svelte
<script>
	import panzoom from 'panzoom';
	import { onMount } from 'svelte';

	let panZoomTarget: SVGGElement;
	let instance: ReturnType<typeof panzoom>;

	onMount(() => {
		instance = panzoom(panZoomTarget, {
			bounds: true,
			maxZoom: 2,
			minZoom: 0.25,
			smoothScroll: false // We control zoom via buttons
		});
		return () => instance.dispose();
	});

	function fitAll() {
		const { zoom, panX, panY } = calculateFitAll();
		instance.zoomAbs(panX, panY, zoom);
	}
</script>

<svg class="canvas">
	<g bind:this={panZoomTarget}>
		{#each racks as rack}
			<Rack {rack} />
		{/each}
	</g>
</svg>
```

**Canvas Structure Change:**

```
Before (v0.1):
<svg> → <Rack /> <Rack /> ...

After (v0.2):
<svg> → <g panzoom-target> → <Rack /> <Rack /> ...
```

### 4.2 Coordinate System: getScreenCTM()

**Decision:** Refactor coordinate transformation to use `getScreenCTM().inverse()`.

**Rationale:**

- Current approach manually compensates for zoom scale
- Breaks when pan (translate) transforms are added
- `getScreenCTM()` automatically accounts for all CSS transforms
- More robust across nested SVG structures

**Implementation:**

```typescript
/**
 * Convert screen coordinates to SVG user space coordinates.
 * Accounts for all transforms (zoom, pan, CSS) automatically.
 */
export function screenToSVG(
	svg: SVGSVGElement,
	clientX: number,
	clientY: number
): { x: number; y: number } {
	const pt = svg.createSVGPoint();
	pt.x = clientX;
	pt.y = clientY;
	const transformed = pt.matrixTransform(svg.getScreenCTM()!.inverse());
	return { x: transformed.x, y: transformed.y };
}

/**
 * Convert SVG user space coordinates to screen coordinates.
 */
export function svgToScreen(
	svg: SVGSVGElement,
	x: number,
	y: number
): { clientX: number; clientY: number } {
	const pt = svg.createSVGPoint();
	pt.x = x;
	pt.y = y;
	const transformed = pt.matrixTransform(svg.getScreenCTM()!);
	return { clientX: transformed.x, clientY: transformed.y };
}
```

**Migration:**

- Replace all `getBoundingClientRect()` + manual zoom compensation
- Remove `zoomScale` parameter from coordinate calculation functions
- Update drag-drop handlers to use new utilities

### 4.3 Dependency Addition

Add to `package.json`:

```json
{
	"dependencies": {
		"panzoom": "^9.4.3"
	}
}
```

---

## 5. Out of Scope (v0.2)

Explicitly deferred:

- Export both front/rear views in single image
- Device library export (save to file)
- Rack templates/presets
- Mobile support (v0.3)
- Undo/redo (v0.3.1)

---

## 6. Migration Notes

### 6.1 v0.1 → v0.2 Layout Loading

When loading a v0.1 layout:

- `Rack.view` defaults to `'front'`
- `PlacedDevice.face` defaults to `'front'`
- No user action required

### 6.2 Version Detection

Layout files include `version` field. Loader handles:

- `0.1.x`: Apply defaults for new fields
- `0.2.x`: Load as-is

---

## 7. Success Criteria

v0.2 is complete when:

- [ ] User can toggle between front/rear rack view
- [ ] Devices can be assigned to front, rear, or both faces
- [ ] "Fit All" zooms canvas to show all racks
- [ ] Racks can be duplicated with all devices
- [ ] Device library can be imported from JSON
- [ ] Device Library button (with Rackarr icon) toggles drawer
- [ ] Device Library drawer has no X close button
- [ ] Rack titles appear above racks (canvas and export)
- [ ] Device icons are vertically centred
- [ ] Help panel shows only GitHub link (no Forgejo)
- [ ] All existing v0.1 functionality preserved
- [ ] v0.1 layouts load correctly with appropriate defaults
- [ ] panzoom library integrated for canvas zoom/pan
- [ ] Coordinate handling uses getScreenCTM() for transform-aware positioning
- [ ] Drag-and-drop works correctly at all zoom levels and pan positions

---

## 8. Related Documents

- [[spec|Base Specification (v0.1)]]
- [[roadmap|Product Roadmap]]
- [[design-methodology|Design Methodology]]
- [[v0.3-spec|v0.3 Mobile Specification]]

---

_This specification extends the base v0.1 spec. Read both documents for complete requirements._
