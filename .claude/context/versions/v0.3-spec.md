---
created: 2025-11-28
updated: 2025-11-28
version: 0.3.0
status: draft
parent: '[[spec]]'
---

# Rackarr v0.3.0 — Mobile & PWA

**Parent Spec:** [[spec|v0.1 Base Specification]]  
**Builds On:** [[v0.2-spec|v0.2 Multi-View & Polish]]

This document specifies mobile support and Progressive Web App capabilities for Rackarr.

---

## 1. Version Overview

### 1.1 Goals

- Full create/edit functionality on mobile phones
- Touch-optimised interaction paradigm (two-tap placement)
- Progressive Web App with offline support
- Installable to home screen
- Responsive layout adapting to screen size

### 1.2 Design Philosophy

**Phone-first, not phone-only.** Mobile is the primary target for v0.3, but the desktop experience must remain unchanged. This is achieved through:

- **Adaptive design:** Different interaction paradigms per platform
- **Responsive layout:** CSS-driven layout changes at breakpoints
- **Progressive enhancement:** Touch features layer on top of existing mouse/keyboard support

### 1.3 Breaking Changes

None. v0.3 layouts are fully compatible with v0.1 and v0.2.

---

## 2. Platform Detection

### 2.1 Detection Strategy

Use feature detection over user-agent sniffing:

```typescript
interface PlatformCapabilities {
	hasTouch: boolean;
	hasMouse: boolean;
	hasKeyboard: boolean;
	screenWidth: number;
	screenHeight: number;
	isStandalone: boolean; // PWA installed
}

function detectPlatform(): PlatformCapabilities {
	return {
		hasTouch: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
		hasMouse: window.matchMedia('(pointer: fine)').matches,
		hasKeyboard: !('ontouchstart' in window), // Heuristic
		screenWidth: window.innerWidth,
		screenHeight: window.innerHeight,
		isStandalone: window.matchMedia('(display-mode: standalone)').matches
	};
}
```

### 2.2 Interaction Mode

Determine primary interaction mode:

| Condition               | Mode    | Behaviour                        |
| ----------------------- | ------- | -------------------------------- |
| `hasMouse && !hasTouch` | Desktop | Original drag-and-drop           |
| `hasTouch && !hasMouse` | Mobile  | Two-tap placement                |
| `hasTouch && hasMouse`  | Hybrid  | Support both (tablet with mouse) |

### 2.3 Breakpoints

```css
/* Phone portrait */
@media (max-width: 479px) {
}

/* Phone landscape / small tablet */
@media (min-width: 480px) and (max-width: 767px) {
}

/* Tablet portrait */
@media (min-width: 768px) and (max-width: 1023px) {
}

/* Desktop (existing layout) */
@media (min-width: 1024px) {
}
```

**Primary target:** Phone portrait (< 480px width)

---

## 3. Mobile Layout

### 3.1 Layout Structure

Replace side drawers with bottom sheets on mobile:

```
┌─────────────────────────────┐
│  Toolbar (compact, 56px)    │
├─────────────────────────────┤
│                             │
│                             │
│       Canvas Area           │
│    (single rack view)       │
│                             │
│                             │
├─────────────────────────────┤
│  ◀ Rack 1 of 3 ▶  [+ New]  │  ← Rack Navigator
├─────────────────────────────┤
│  ░░░░░░░░░░░░░░░░░░░░░░░░░ │  ← Bottom Sheet Handle
│  Device Library (collapsed) │
└─────────────────────────────┘
```

### 3.2 Mobile Toolbar

**Height:** 56px (minimum touch target compliant)

**Contents (left to right):**

| Element               | Action                                  |
| --------------------- | --------------------------------------- |
| Rackarr icon          | Opens menu sheet                        |
| Rack name (truncated) | Tap to edit                             |
| [Front/Rear]          | View toggle (if v0.2 rear view enabled) |
| [⋮] More menu         | Save, Load, Export, Help                |

**Omitted from mobile toolbar:**

- Zoom controls (use pinch gesture)
- Theme toggle (in menu)
- Delete button (in edit sheet)

### 3.3 Menu Sheet

Opened by tapping Rackarr icon. Full-height sheet with:

- **New Rack** button
- **Save Layout** button
- **Load Layout** button
- **Export** button
- **Theme Toggle** (Dark/Light)
- **Help/About** link
- App version

### 3.4 Rack Navigator

Fixed bar above bottom sheet:

```
◀  Rack 1 of 3  ▶  [+]
```

- **◀ / ▶:** Navigate between racks
- **Rack X of Y:** Current position indicator
- **[+]:** Quick add new rack

**Swipe gesture:** Swipe left/right on canvas also navigates racks.

### 3.5 Bottom Sheet Behaviour

**States:**

| State         | Height       | Trigger                                  |
| ------------- | ------------ | ---------------------------------------- |
| **Collapsed** | 80px         | Default, shows handle + "Device Library" |
| **Half**      | 40% viewport | Tap handle or swipe up                   |
| **Expanded**  | 90% viewport | Continue swipe up from half              |
| **Hidden**    | 0px          | When edit sheet is open                  |

**Gesture handling:**

- Swipe up: Expand to next state
- Swipe down: Collapse to previous state
- Tap handle: Toggle between collapsed and half

**Content when expanded:**

- Search field
- Category-grouped device list
- "Add Device" button
- "Import Library" button (from v0.2)

### 3.6 Edit Sheet

When device or rack is selected, a modal sheet appears:

**Trigger:** Tap placed device or rack header

**Behaviour:**

- Slides up from bottom
- 60-80% viewport height
- Backdrop dims canvas
- Tap backdrop or swipe down to close

**Contents (device selected):**

- Device name (read-only, shows library reference)
- Position: U number (editable spinner)
- Mounted Face: Front / Rear / Both (radio)
- **Move to Rack:** Dropdown (if multiple racks)
- **Delete Device** button (destructive, red)

**Contents (rack selected):**

- Rack name (editable)
- Height in U (editable with constraints)
- Utilisation percentage (read-only)
- **Duplicate Rack** button
- **Delete Rack** button (confirmation if not empty)

---

## 4. Touch Interaction Model

### 4.1 Two-Tap Device Placement

**The core mobile interaction pattern.**

#### Step 1: Select Device from Library

1. User opens Device Library (bottom sheet)
2. User taps a device in the list
3. Device shows "selected" state (highlighted border, checkmark)
4. Toast appears: "Tap a U position to place [Device Name]"
5. Bottom sheet auto-collapses to show canvas

#### Step 2: Place Device in Rack

1. User taps a U position in the rack
2. If valid: Device placed, brief success animation, selection cleared
3. If invalid (collision): Error feedback (shake, red flash), selection maintained
4. User can tap different position or tap "Cancel" in toast

#### Cancellation

- Tap anywhere outside rack: Cancels placement
- Tap selected device again: Deselects
- Swipe up bottom sheet: Returns to library (maintains selection)

### 4.2 Device Selection States

```typescript
type SelectionState =
	| { mode: 'none' }
	| { mode: 'library-device'; deviceId: string } // Ready to place
	| { mode: 'placed-device'; rackId: string; deviceId: string } // Editing
	| { mode: 'rack'; rackId: string }; // Editing rack
```

### 4.3 Moving Placed Devices

**Within same rack:**

1. Tap placed device → Edit sheet opens
2. Use position spinner to change U position
3. Collision detection prevents invalid positions

**Between racks:**

1. Tap placed device → Edit sheet opens
2. Select different rack from "Move to Rack" dropdown
3. If collision at current position in target rack, show error
4. Device moves to same U position in new rack

**Alternative (drag on mobile):**
Long-press (500ms) on placed device enables drag mode:

- Device "lifts" with shadow
- Drag to new position (same rack only)
- Release to drop
- Requires more precision, offered as power-user option

### 4.4 Rack Interactions

**View rack:** Default state, shows devices

**Select rack:** Tap rack header (title area) → Edit sheet opens

**Navigate racks:**

- Tap ◀ / ▶ in rack navigator
- Swipe left/right on canvas

**Zoom rack:**

- Pinch gesture zooms canvas
- Double-tap resets to fit-all

### 4.5 Touch Feedback

All touch interactions require immediate visual feedback:

| Action                   | Feedback                    |
| ------------------------ | --------------------------- |
| Tap device in library    | Ripple effect, highlight    |
| Tap U position (valid)   | Green flash, device appears |
| Tap U position (invalid) | Red flash, shake animation  |
| Long-press device        | Lift animation, shadow      |
| Swipe between racks      | Smooth scroll transition    |
| Pinch zoom               | Immediate scale response    |

---

## 5. Gesture Reference

### 5.1 Canvas Gestures

| Gesture               | Action                   |
| --------------------- | ------------------------ |
| **Tap U position**    | Place selected device    |
| **Tap placed device** | Open edit sheet          |
| **Tap rack header**   | Open rack edit sheet     |
| **Swipe left/right**  | Navigate between racks   |
| **Pinch**             | Zoom in/out              |
| **Double-tap**        | Fit current rack to view |
| **Long-press device** | Enable drag mode         |

### 5.2 Bottom Sheet Gestures

| Gesture        | Action                |
| -------------- | --------------------- |
| **Tap handle** | Toggle collapsed/half |
| **Swipe up**   | Expand sheet          |
| **Swipe down** | Collapse sheet        |
| **Tap device** | Select for placement  |

### 5.3 Edit Sheet Gestures

| Gesture          | Action      |
| ---------------- | ----------- |
| **Swipe down**   | Close sheet |
| **Tap backdrop** | Close sheet |

---

## 6. Progressive Web App

### 6.1 Web App Manifest

```json
{
	"name": "Rackarr",
	"short_name": "Rackarr",
	"description": "Rack layout designer for homelabbers",
	"start_url": "/",
	"display": "standalone",
	"background_color": "#1a1a1a",
	"theme_color": "#1a1a1a",
	"orientation": "any",
	"icons": [
		{
			"src": "/icons/icon-192.png",
			"sizes": "192x192",
			"type": "image/png",
			"purpose": "any maskable"
		},
		{
			"src": "/icons/icon-512.png",
			"sizes": "512x512",
			"type": "image/png",
			"purpose": "any maskable"
		}
	]
}
```

### 6.2 Service Worker Strategy

**Caching strategy:** Cache-first for app shell, network-first for nothing (no API calls).

```javascript
// Service worker registration
if ('serviceWorker' in navigator) {
	navigator.serviceWorker.register('/sw.js');
}

// sw.js - Cache app shell on install
const CACHE_NAME = 'rackarr-v0.3.0';
const APP_SHELL = [
	'/',
	'/index.html',
	'/assets/index.js',
	'/assets/index.css',
	'/icons/icon-192.png',
	'/icons/icon-512.png',
	'/manifest.json'
];

self.addEventListener('install', (event) => {
	event.waitUntil(caches.open(CACHE_NAME).then((cache) => cache.addAll(APP_SHELL)));
});

self.addEventListener('fetch', (event) => {
	event.respondWith(
		caches.match(event.request).then((response) => response || fetch(event.request))
	);
});
```

### 6.3 Offline Indicator

When offline (`!navigator.onLine`):

- Show subtle indicator in toolbar (cloud-off icon)
- All functionality works normally
- Save/Load work with local files (no change)
- Toast on reconnection: "Back online"

### 6.4 Install Prompt

**Criteria for showing install prompt:**

- User has visited 2+ times
- User has interacted with app (created rack or device)
- Browser supports installation
- App not already installed

**Prompt UI:**

- Banner at bottom: "Add Rackarr to Home Screen"
- Dismiss button (remembers preference for 7 days)
- Install button triggers browser's native prompt

### 6.5 Standalone Mode Adjustments

When running as installed PWA (`display-mode: standalone`):

- Hide install prompt permanently
- Adjust safe areas for notched devices:

```css
@supports (padding-top: env(safe-area-inset-top)) {
	.toolbar {
		padding-top: env(safe-area-inset-top);
	}
	.bottom-sheet {
		padding-bottom: env(safe-area-inset-bottom);
	}
}
```

---

## 7. Responsive Component Adaptations

### 7.1 Toolbar

| Viewport            | Behaviour                          |
| ------------------- | ---------------------------------- |
| Desktop (≥1024px)   | Full toolbar per v0.2 spec         |
| Tablet (768-1023px) | Full toolbar, larger touch targets |
| Phone (<768px)      | Compact toolbar, menu overflow     |

### 7.2 Device Library

| Viewport | Behaviour                                  |
| -------- | ------------------------------------------ |
| Desktop  | Left drawer (280-320px)                    |
| Tablet   | Left drawer or bottom sheet (user choice?) |
| Phone    | Bottom sheet only                          |

### 7.3 Edit Panel

| Viewport | Behaviour                |
| -------- | ------------------------ |
| Desktop  | Right drawer (280-320px) |
| Tablet   | Right drawer             |
| Phone    | Modal bottom sheet       |

### 7.4 Canvas

| Viewport | Behaviour                       |
| -------- | ------------------------------- |
| Desktop  | Multi-rack horizontal layout    |
| Tablet   | Multi-rack horizontal layout    |
| Phone    | Single rack view with navigator |

### 7.5 Rack Rendering

No changes to SVG rack rendering. Mobile uses same components with:

- Touch event handlers added
- Larger hit areas for U positions (extend invisible tap target)

---

## 8. Touch Target Sizing

### 8.1 Minimum Sizes

Per Material Design guidelines:

| Element      | Minimum Size | Minimum Spacing |
| ------------ | ------------ | --------------- |
| Buttons      | 48×48px      | 8px             |
| List items   | 48px height  | —               |
| Icon buttons | 48×48px      | 8px             |
| Form inputs  | 48px height  | —               |

### 8.2 U Position Touch Targets

**Challenge:** 1U = 22px height, below 48px minimum.

**Solution:** Invisible expanded touch target:

```css
.u-slot {
	height: 22px; /* Visual size */
	position: relative;
}

.u-slot::before {
	content: '';
	position: absolute;
	top: -13px; /* Expand to ~48px total */
	bottom: -13px;
	left: 0;
	right: 0;
}
```

**Conflict resolution:** When tapping between two U slots, use the one whose centre is closest to tap point.

### 8.3 Device Touch Targets in Library

Minimum 48px height per device item, with:

- Category icon (24px)
- Device name (truncated if needed)
- Height badge ("2U")

---

## 9. Performance Considerations

### 9.1 Touch Responsiveness

- Touch feedback must appear within 100ms
- Use CSS transforms for animations (GPU accelerated)
- Debounce resize handlers (100ms)
- Throttle pinch zoom (16ms / 60fps)

### 9.2 Memory Management

- Limit undo history on mobile (10 steps vs 50 on desktop) — v0.3.1
- Lazy-load device library categories
- Virtualise long device lists (if >50 items)

### 9.3 Battery Considerations

- No continuous animations when idle
- Reduce animation complexity on low-power mode (if detectable)
- Service worker enables offline use (reduces network activity)

---

## 10. Accessibility on Mobile

### 10.1 Screen Reader Support

- All touch targets have accessible labels
- Bottom sheet state announced ("Device Library, expanded")
- Placement feedback announced ("Server placed at U10")
- Navigation announced ("Viewing Rack 2 of 3")

### 10.2 Motor Accessibility

- Two-tap is easier than drag for users with motor impairments
- All actions possible without gestures (tap alternatives available)
- Sufficient touch target sizes

### 10.3 Visual Accessibility

- Maintain colour contrast ratios from v0.1
- Support system font size scaling
- Pinch zoom available for magnification

---

## 11. Technical Dependencies

### 11.1 Gesture Library: Hammer.js

**Decision:** Adopt [@egjs/hammerjs](https://github.com/naver/hammer.js) (~7KB gzipped) for mobile gesture handling.

**Rationale:**

- Battle-tested cross-browser touch handling
- Unified API for tap, pinch, pan, swipe
- Handles edge cases (multi-touch, gesture conflicts)
- Active maintenance (@egjs fork)
- Avoids reinventing cross-browser gesture code

**Integration:**

```typescript
import Hammer from '@egjs/hammerjs';

function setupCanvasGestures(canvasElement: HTMLElement) {
	const hammer = new Hammer(canvasElement);

	// Enable pinch (disabled by default)
	hammer.get('pinch').set({ enable: true });

	// Configure pan for rack navigation
	hammer.get('pan').set({
		direction: Hammer.DIRECTION_HORIZONTAL,
		threshold: 30 // Prevent accidental triggers
	});

	hammer.on('tap', handleTap);
	hammer.on('pinch', handlePinch);
	hammer.on('panleft panright', handleSwipe);

	return () => hammer.destroy();
}
```

**Gesture Mapping:**

| Hammer Event         | Rackarr Action                             |
| -------------------- | ------------------------------------------ |
| `tap`                | Place device, select device, select U slot |
| `press` (long-press) | Enable drag mode for device                |
| `pinch`              | Zoom canvas                                |
| `panleft`/`panright` | Navigate between racks                     |

### 11.2 Coordinate Handling with v0.2 panzoom

Mobile gestures integrate with panzoom (added in v0.2):

```typescript
// Pinch-to-zoom via Hammer.js → panzoom
hammer.on('pinch', (e) => {
	const scale = e.scale;
	const center = { x: e.center.x, y: e.center.y };
	panzoomInstance.zoomTo(center.x, center.y, scale);
});
```

**Note:** Disable panzoom's built-in touch handling to avoid conflicts:

```typescript
panzoom(element, {
	// ... other options
	smoothScroll: false,
	zoomDoubleClickSpeed: 1, // Disable double-click zoom
	beforeMouseDown: () => false, // Disable mouse drag (we use buttons)
	beforeTouch: () => false // We handle touch via Hammer.js
});
```

### 11.3 Dependency Addition

Add to `package.json`:

```json
{
	"dependencies": {
		"@egjs/hammerjs": "^2.0.17"
	}
}
```

---

## 12. Testing Requirements

### 12.1 Device Testing Matrix

**Primary (must pass):**

- iPhone SE (375×667) — smallest common iPhone
- iPhone 14 (390×844) — current mainstream
- Pixel 7 (412×915) — current Android flagship
- Samsung Galaxy S21 (360×800) — popular Android

**Secondary (should pass):**

- iPhone 14 Pro Max (430×932) — large phone
- iPad Mini (768×1024) — smallest tablet
- Pixel Fold (unfolded) — foldable consideration

### 12.2 Test Scenarios

1. **Two-tap placement flow:** Select device → tap U → verify placement
2. **Collision handling:** Attempt invalid placement → verify feedback
3. **Rack navigation:** Swipe between racks → verify smooth transition
4. **Pinch zoom:** Zoom in/out → verify responsive scaling
5. **Bottom sheet:** All states → verify gesture handling
6. **PWA install:** Install flow → verify standalone mode
7. **Offline mode:** Disable network → verify full functionality
8. **Orientation change:** Rotate device → verify layout adaptation

### 12.3 E2E Test Additions

Extend Playwright tests with mobile emulation:

```javascript
// playwright.config.ts
projects: [
	{ name: 'Mobile Safari', use: devices['iPhone 14'] },
	{ name: 'Mobile Chrome', use: devices['Pixel 7'] }
];
```

---

## 13. Out of Scope (v0.3)

Explicitly deferred:

- Tablet-optimised layout (uses phone layout)
- Haptic feedback (nice-to-have, not essential)
- Gesture customisation
- Landscape-specific optimisations
- Share sheet integration
- Widget support

---

## 14. Migration Notes

### 14.1 No Data Migration Required

v0.3 adds no new data fields. Layout files from v0.1/v0.2 work unchanged.

### 14.2 Feature Detection

Mobile features activate automatically based on platform detection. No user configuration required.

---

## 15. Success Criteria

v0.3 is complete when:

- [ ] User can create racks on mobile phone
- [ ] User can place devices using two-tap flow
- [ ] User can move devices within and between racks
- [ ] User can edit device and rack properties via sheet
- [ ] User can navigate between racks via swipe or buttons
- [ ] User can zoom canvas via pinch gesture
- [ ] User can save/load layouts on mobile
- [ ] User can export images on mobile
- [ ] PWA is installable to home screen
- [ ] App works fully offline
- [ ] All touch targets meet 48px minimum
- [ ] All mobile gestures have immediate visual feedback
- [ ] Desktop experience unchanged
- [ ] Passes testing on iPhone SE, iPhone 14, Pixel 7
- [ ] Hammer.js integrated for gesture handling
- [ ] Pinch-to-zoom integrates with panzoom smoothly
- [ ] No gesture conflicts between Hammer.js and panzoom

---

## 16. Related Documents

- [[spec|Base Specification (v0.1)]]
- [[v0.2-spec|v0.2 Multi-View & Polish]]
- [[design-methodology|Design Methodology]]
- [[roadmap|Product Roadmap]]

---

_This specification builds on v0.1 and v0.2. Read all three documents for complete requirements._
