# v0.4.0 Code Audit Prompt Plan

**Spec:** `docs/planning/v0.4.0-code-audit-spec.md`
**Created:** 2025-12-06

---

## Execution Order

Prompts must be executed in order due to dependencies. Each prompt should be committed separately.

---

## Prompt 1: Baseline & Branch Setup

**Goal:** Establish baseline metrics and create feature branch

**Tasks:**

1. Create feature branch `feature/code-audit-v0.4.0`
2. Run `npm run test:run` and record test count
3. Run `npm run build` and verify success
4. Run `npm run lint` and record any warnings
5. Document baseline in this file

**Commit:** `chore: create code audit branch with baseline`

---

## Prompt 2: Remove Legacy Test Files

**Goal:** Remove test files for legacy format code

**Files to DELETE:**

- `src/tests/migration.test.ts`
- `src/tests/migrate-v02.test.ts`
- `src/tests/types-v02.test.ts`
- `src/tests/schemas-v02.test.ts`
- `src/tests/layout-helpers-v02.test.ts`
- `src/tests/archive.test.ts` (old format)
- `src/tests/serialization.test.ts` (old format)

**Verification:**

- Tests may fail initially (expected - source files still reference legacy code)
- Note which tests were removed for changelog

**Commit:** `refactor: remove legacy format test files`

---

## Prompt 3: Remove Legacy Source Files

**Goal:** Remove legacy format source files

**Files to DELETE:**

- `src/lib/utils/archive.ts` (old JSON archive)
- `src/lib/utils/migration.ts`
- `src/lib/utils/migrate-v02.ts`
- `src/lib/utils/serialization.ts` (old format)
- `src/lib/data/starterLibrary.ts` (old starter library)

**Note:** Do NOT delete `src/lib/types/index.ts` yet - it exports types that may still be used elsewhere. We'll handle this in Prompt 5.

**Verification:**

- Build will fail (expected - imports need updating)

**Commit:** `refactor: remove legacy format source files`

---

## Prompt 4: Rename Current Format Files

**Goal:** Rename v02-suffixed files to proper names

**Renames:**

- `src/lib/utils/folder.ts` → `src/lib/utils/archive.ts`
- `src/lib/utils/serialization-v02.ts` → `src/lib/utils/serialization.ts`
- `src/lib/types/v02.ts` → Keep as-is for now (complex re-export situation)
- `src/lib/schemas/v02.ts` → `src/lib/schemas/index.ts`
- `src/lib/stores/layout-helpers-v02.ts` → `src/lib/stores/layout-helpers.ts`
- `src/lib/data/starterLibraryV02.ts` → `src/lib/data/starterLibrary.ts`
- `src/tests/folder.test.ts` → `src/tests/archive.test.ts`

**Verification:**

- Update all imports in the renamed files
- Build will still fail (external imports need updating)

**Commit:** `refactor: rename v02 files to standard names`

---

## Prompt 5: Update All Imports

**Goal:** Fix all import statements throughout codebase

**Files to update:**

- All files importing from renamed modules
- All files importing from deleted modules
- `src/App.svelte` - major changes needed
- `src/lib/stores/layout.svelte.ts` - update imports
- `src/lib/utils/file.ts` - update imports, remove legacy functions
- `src/lib/utils/session.ts` - update imports, remove migration
- Any other files with broken imports

**Type consolidation:**

- Update `src/lib/types/index.ts` to re-export from v02.ts
- Or replace index.ts content entirely with v02.ts content
- Remove deprecated type aliases

**Verification:**

- `npm run build` succeeds
- `npm run check` succeeds

**Commit:** `refactor: update all imports after legacy removal`

---

## Prompt 6: Update App.svelte Legacy Handling

**Goal:** Remove legacy format branches from file loading

**Changes in `src/App.svelte`:**

- Remove `legacy-archive` format handling (lines ~154-180)
- Remove `legacy-json` format handling (lines ~181-196)
- Remove imports: `extractArchive`, `migrateToV02`, `migrateImages`
- Update `detectFileFormatAsync` usage - only handle `folder-archive`
- Add user-friendly error for unsupported formats

**Verification:**

- Build succeeds
- App loads `.rackarr.zip` (YAML format) correctly
- App shows error for old format files

**Commit:** `refactor: remove legacy format handling from App.svelte`

---

## Prompt 7: Update file.ts and session.ts

**Goal:** Clean up file utilities

**Changes in `src/lib/utils/file.ts`:**

- Remove `FileFormat` type (only archive format now)
- Simplify `detectFileFormat` - only check for .zip
- Remove `detectFileFormatAsync` detailed format detection
- Remove legacy JSON functions if any remain
- Update `openFilePicker` to only accept `.rackarr.zip`

**Changes in `src/lib/utils/session.ts`:**

- Remove migration import
- Remove version checking/migration logic
- Simplify to current format only

**Verification:**

- Build succeeds
- All remaining tests pass

**Commit:** `refactor: simplify file.ts and session.ts for single format`

---

## Prompt 8: Dead Code Scan - Source

**Goal:** Find and remove remaining dead code in source files

**Process:**

1. Run TypeScript with strict unused checks
2. Run ESLint with no-unused-vars
3. Manual inspection of:
   - Unused imports in each file
   - Unused exports
   - Commented-out code
   - Unreachable code paths

**Focus areas:**

- `src/lib/components/` - all components
- `src/lib/stores/` - all stores
- `src/lib/utils/` - all utilities

**Verification:**

- `npm run lint` clean
- `npm run check` clean
- Build succeeds

**Commit:** `refactor: remove dead code from source files`

---

## Prompt 9: Dead Code Scan - Tests

**Goal:** Find and remove redundant tests

**Process:**

1. Review each test file for:
   - Tests covering removed functionality
   - Duplicate test cases
   - Obsolete mocks/fixtures
2. Remove redundant tests
3. Update test descriptions if needed

**Verification:**

- All tests pass
- No test errors or warnings

**Commit:** `refactor: remove redundant test code`

---

## Prompt 10: CSS Cleanup

**Goal:** Remove unused CSS

**Process:**

1. Audit `src/lib/styles/tokens.css`:
   - Search for each CSS variable usage
   - Remove unused variables
2. Audit `src/app.css`:
   - Search for each class usage
   - Remove unused utility classes
3. Audit component `<style>` blocks:
   - Remove unused selectors

**Verification:**

- Build succeeds
- Visual inspection of app

**Commit:** `refactor: remove unused CSS`

---

## Prompt 11: Dependencies Audit

**Goal:** Remove unused npm packages

**Process:**

1. Review `package.json` dependencies
2. Search codebase for each package import
3. Remove unused packages with `npm uninstall`

**Candidates to check:**

- All devDependencies
- All runtime dependencies

**Verification:**

- `npm install` succeeds
- Build succeeds
- All tests pass

**Commit:** `refactor: remove unused npm dependencies`

---

## Prompt 12: Config Cleanup

**Goal:** Clean up configuration files

**Files to review:**

- `vite.config.ts`
- `vitest.config.ts`
- `eslint.config.js`
- `tsconfig.json`
- `playwright.config.ts`

**Tasks:**

- Remove unused/redundant options
- Ensure configs are minimal and correct

**Verification:**

- All commands work correctly
- Build succeeds

**Commit:** `chore: clean up configuration files`

---

## Prompt 13: Documentation Cleanup

**Goal:** Update all documentation

**Files to update:**

- `docs/planning/spec-combined.md` - Remove legacy format references
- `CLAUDE.md` - Update version, remove migration mentions
- `docs/planning/ROADMAP.md` - Update changelog
- `README.md` (if exists) - Update format documentation

**Tasks:**

- Remove all v0.1/v0.2 format documentation
- Update format documentation to v0.3+ only
- Update version references to v0.4.0

**Commit:** `docs: remove legacy format documentation`

---

## Prompt 14: Final Verification & Version Bump

**Goal:** Final checks and version update

**Tasks:**

1. Run full test suite: `npm run test:run`
2. Run E2E tests: `npm run test:e2e`
3. Run build: `npm run build`
4. Run lint: `npm run lint`
5. Run type check: `npm run check`
6. Manual smoke test:
   - Create new rack
   - Add devices
   - Save layout
   - Load layout
   - Export image
7. Update version to 0.4.0 in:
   - `package.json`
   - `CLAUDE.md`

**Commit:** `chore: release v0.4.0`

---

## Prompt 15: Merge & Release

**Goal:** Merge to main and create release

**Tasks:**

1. Merge feature branch to main
2. Push to origin
3. Create v0.4.0 tag
4. Push tags

**Commands:**

```bash
git checkout main
git merge feature/code-audit-v0.4.0
git push origin main
git tag v0.4.0
git push origin v0.4.0
```

---

## Baseline Metrics

- **Test count:** 1899 tests (89 test files)
- **Build status:** Success (375.54 kB JS, 48.63 kB CSS)
- **Lint warnings:** 0 (clean)

---

## Post-Audit Metrics

(To be filled in during Prompt 14)

- **Test count:** \_\_\_
- **Tests removed:** \_\_\_
- **Files removed:** \_\_\_
- **Dependencies removed:** \_\_\_
