# v0.4.0 Code Audit & Legacy Cleanup Specification

**Status:** Draft
**Created:** 2025-12-06
**Target:** v0.4.0
**Breaking Change:** Yes (drops v0.1/v0.2 format support)

---

## Overview

Full codebase audit to remove dead code, legacy migration support, unused dependencies, and align documentation. This is a blocking release before any new feature work.

---

## Goals

1. Remove all v0.1/v0.2 legacy format migration code
2. Eliminate dead code from source and tests
3. Remove unused CSS classes and variables
4. Audit and remove unused npm dependencies
5. Clean up configuration files
6. Align all documentation to v0.3+ only

---

## Non-Goals

- Adding new features
- Refactoring working code for style preferences
- Changing architecture or patterns
- Performance optimizations (unless dead code removal helps)

---

## Audit Areas

### 1. Legacy Format Removal

**Architecture Context:**
The codebase has confusing naming where "v02" suffix indicates the CURRENT format (YAML-based, slug-based, single-rack) and non-suffixed files are the OLD format (JSON-based, UUID-based, multi-rack).

**Files to REMOVE (Legacy format):**

- `src/lib/utils/archive.ts` - Old v0.1 JSON-based ZIP archive
- `src/lib/utils/migration.ts` - Old format field migration
- `src/lib/utils/migrate-v02.ts` - Migration from old to current format
- `src/lib/utils/serialization.ts` - Old format serialization/validation
- `src/lib/types/index.ts` - Old type definitions (camelCase, multi-rack)
- `src/lib/data/starterLibrary.ts` - Old starter library

**Files to KEEP & RENAME (Current format):**

- `src/lib/utils/folder.ts` → `src/lib/utils/archive.ts` (current YAML archive)
- `src/lib/utils/serialization-v02.ts` → `src/lib/utils/serialization.ts`
- `src/lib/types/v02.ts` → `src/lib/types/index.ts`
- `src/lib/schemas/v02.ts` → `src/lib/schemas/index.ts`
- `src/lib/stores/layout-helpers-v02.ts` → `src/lib/stores/layout-helpers.ts`
- `src/lib/data/starterLibraryV02.ts` → `src/lib/data/starterLibrary.ts`

**Files to UPDATE:**

- `src/App.svelte` - Remove legacy-archive and legacy-json handling branches
- `src/lib/utils/file.ts` - Remove legacy format detection/support
- `src/lib/utils/session.ts` - Remove old format migration calls

**Test files to REMOVE:**

- `src/tests/migration.test.ts`
- `src/tests/migrate-v02.test.ts`
- `src/tests/types-v02.test.ts`
- `src/tests/schemas-v02.test.ts`
- `src/tests/layout-helpers-v02.test.ts`
- `src/tests/archive.test.ts` (old format tests)
- `src/tests/serialization.test.ts` (old format tests)

**Test files to KEEP & RENAME:**

- `src/tests/folder.test.ts` → `src/tests/archive.test.ts`

**Breaking Change:**

- Old `.rackarr` files (v0.1/v0.2 JSON format) will no longer load
- Old `.rackarr.zip` files with `layout.json` structure will no longer load
- Only `.rackarr.zip` files with YAML folder structure are supported

---

### 2. Dead Code (Source)

**Audit targets:**

- `src/lib/components/` - All Svelte components
- `src/lib/stores/` - State management
- `src/lib/services/` - Business logic
- `src/lib/utils/` - Utility functions
- `src/lib/types/` - TypeScript types

**Tasks:**

- [ ] Identify unused imports in each file
- [ ] Identify unused exports (functions, types, constants)
- [ ] Identify unreachable code paths
- [ ] Identify commented-out code blocks
- [ ] Remove all identified dead code

**Tools:**

- TypeScript compiler (`tsc --noUnusedLocals --noUnusedParameters`)
- ESLint unused rules
- Manual inspection

---

### 3. Dead Code (Tests)

**Audit targets:**

- `src/tests/` - Unit tests
- `e2e/` - Playwright E2E tests

**Tasks:**

- [ ] Identify redundant/duplicate test cases
- [ ] Identify tests for removed functionality
- [ ] Identify obsolete test fixtures/mocks
- [ ] Remove tests that test legacy migration
- [ ] Consolidate overlapping test coverage

---

### 4. CSS Cleanup

**Audit targets:**

- `src/lib/styles/tokens.css` - Design tokens
- `src/app.css` - Global styles
- Component `<style>` blocks

**Tasks:**

- [ ] Identify unused CSS custom properties in tokens.css
- [ ] Identify unused utility classes in app.css
- [ ] Identify unused styles in component style blocks
- [ ] Remove all unused CSS

**Tools:**

- Manual grep for CSS variable usage
- Browser DevTools coverage report

---

### 5. Dependencies Audit

**Audit targets:**

- `package.json` - Dependencies and devDependencies

**Tasks:**

- [ ] Run `npm ls` to check dependency tree
- [ ] Identify unused production dependencies
- [ ] Identify unused dev dependencies
- [ ] Remove unused packages
- [ ] Verify build still works after removal

**Tools:**

- `depcheck` or manual audit
- `npm ls --all`

---

### 6. Config Cleanup

**Audit targets:**

- `vite.config.ts`
- `vitest.config.ts`
- `eslint.config.js`
- `tsconfig.json`
- `playwright.config.ts`
- `.prettierrc`

**Tasks:**

- [ ] Remove unused/redundant configuration options
- [ ] Remove legacy-related config if any
- [ ] Verify configs are minimal and correct

---

### 7. Documentation Alignment

**Audit targets:**

- `docs/planning/spec-combined.md`
- `CLAUDE.md`
- `docs/planning/ROADMAP.md`
- `README.md` (if exists)

**Tasks:**

- [ ] Remove all references to v0.1/v0.2 format
- [ ] Remove migration documentation
- [ ] Update format documentation to show v0.3+ as the only format
- [ ] Ensure version numbers are correct
- [ ] Remove any outdated feature documentation

---

## Testing Strategy

### Pre-Audit Baseline

1. Run all unit tests - record count
2. Run all E2E tests - record count
3. Run build - verify success
4. Record current test coverage

### Post-Audit Verification

1. All remaining unit tests pass
2. All remaining E2E tests pass
3. Build succeeds
4. App functions correctly:
   - Create new rack
   - Add devices
   - Save layout (v0.3+ format)
   - Load layout (v0.3+ format)
   - Export image
   - All keyboard shortcuts work

### Regression Check

- Old v0.1/v0.2 files should fail gracefully with clear error message (not crash)

---

## Acceptance Criteria

- [ ] No v0.1/v0.2 migration code remains in codebase
- [ ] No unused imports/exports in source files
- [ ] No redundant test coverage
- [ ] No unused npm dependencies in package.json
- [ ] No unused CSS custom properties or classes
- [ ] All docs reference only v0.3+ format
- [ ] All existing tests pass (may have fewer total tests)
- [ ] Build succeeds
- [ ] Manual smoke test passes

---

## Risk Assessment

| Risk                          | Mitigation                                |
| ----------------------------- | ----------------------------------------- |
| Accidentally remove used code | Run full test suite after each removal    |
| Break functionality           | Incremental commits, easy rollback        |
| Miss dead code                | Use multiple detection methods            |
| Users with old files          | Document breaking change in release notes |

---

## Release Notes Template

```markdown
## v0.4.0 - Code Audit & Legacy Cleanup

### Breaking Changes

- **Dropped support for v0.1/v0.2 file format** - Only `.rackarr.zip` files (v0.3+) are now supported. If you have old `.rackarr` files, please load and re-save them in v0.3.x before upgrading.

### Removed

- Legacy format migration code
- [List other removed dead code]

### Changed

- [Any behavioral changes from cleanup]

### Fixed

- [Any bugs discovered during audit]
```

---

## Prompt Plan Reference

See `docs/planning/v0.4.0-code-audit-prompt-plan.md` for implementation steps.
